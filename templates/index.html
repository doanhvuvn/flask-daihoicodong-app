<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Đăng ký Cổ đông</title>
    <link href="https://fonts.cdnfonts.com/css/idautomationhc39m" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            width: 100%;
            max-width: 700px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            background-color: #00796b;
            color: white;
            display: flex;
            align-items: center;
            border-bottom: 4px solid #004d40;
        }

        .logo {
            max-height: 50px;
            margin-right: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .content-area {
            padding: 30px 40px;
        }

        .lookup-form {
            text-align: center;
        }

        .lookup-form h2 {
            color: #333;
        }

        input[type="text"] {
            font-size: 16px;
            padding: 10px;
            margin-top: 10px;
            width: 95%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #shareholder-info {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: left;
        }

        #shareholder-info p {
            margin: 8px 0;
            font-size: 16px;
        }

        #shareholder-info .label {
            font-weight: bold;
        }

        #barcode-display {
            font-family: 'IDAutomationHC39M', sans-serif;
            font-size: 36px;
            display: block;
            text-align: center;
            margin: 10px 0;
        }

        .action-button {
            width: 100%;
            font-size: 18px;
            padding: 12px 20px;
            margin-top: 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #register-button {
            background-color: #28a745;
        }

        #register-button:hover {
            background-color: #218838;
        }

        #reprint-button {
            background-color: #007bff;
        }

        #reprint-button:hover {
            background-color: #0069d9;
        }

        .back-button {
            display: inline-block;
            margin-top: 30px;
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: #5a6268;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Becamex IJC Logo" class="logo">
            <h1>Hệ thống Quản lý Đại hội Cổ đông</h1>
        </header>
        <main class="content-area">
            <div class="lookup-form">
                <h2>Đăng ký Cổ đông</h2>
                <label for="ma_co_dong_input">Vui lòng nhập Mã Cổ Đông:</label><br>
                <input type="text" id="ma_co_dong_input" placeholder="Ví dụ: 16047" autofocus>
            </div>
            <div id="shareholder-info" style="display:none;">
                <p><span class="label">Cổ đông:</span> <span id="info-ho-ten"></span></p>
                <p class="label">Mã cổ đông:</p>
                <span id="barcode-display"></span>
                <p><span class="label">Số CMND/GCNĐKDN:</span> <span id="info-cmnd"></span></p>
                <p><span class="label">Ngày cấp:</span> <span id="info-ngay-cap"></span></p>
                <p><span class="label">Số lượng cổ phần:</span> <span id="info-so-luong-cp"></span></p>

                <button id="register-button" class="action-button" style="display:none;">Đăng ký và In (3
                    phiếu)</button>
                <button id="reprint-button" class="action-button" style="display:none;">In lại (3 phiếu)</button>
            </div>
            <div style="text-align: center;">
                <a href="/" class="back-button">Quay lại Menu chính</a>
            </div>
        </main>
    </div>

    <script>
        const inputField = document.getElementById('ma_co_dong_input');
        const infoContainer = document.getElementById('shareholder-info');
        const registerButton = document.getElementById('register-button');
        const reprintButton = document.getElementById('reprint-button');
        let debounceTimeout;

        function printSingleSlip(url, callback) {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không thể tải tài liệu từ ${url} (lỗi ${response.status})`);
                    }
                    return response.text();
                })
                .then(htmlToPrint => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);

                    iframe.onload = function () {
                        const iframeWindow = iframe.contentWindow;
                        iframeWindow.onafterprint = function () {
                            document.body.removeChild(iframe);
                            if (callback) {
                                callback();
                            }
                        };
                        iframeWindow.focus();
                        iframeWindow.print();
                    };

                    iframe.contentDocument.open();
                    iframe.contentDocument.write(htmlToPrint);
                    iframe.contentDocument.close();
                })
                .catch(error => {
                    console.error('Lỗi khi in:', error);
                    alert('Lỗi in: ' + error.message);
                });
        }

        function resetForm() {
            inputField.value = '';
            infoContainer.style.display = 'none';
            inputField.focus();
        }

        inputField.addEventListener('input', function () {
            clearTimeout(debounceTimeout);
            const maCD = this.value.trim();

            if (!maCD) {
                infoContainer.style.display = 'none';
                return;
            }

            debounceTimeout = setTimeout(() => {
                fetch(`/api/shareholder/${maCD}`)
                    .then(response => {
                        if (!response.ok) { throw new Error('Not found'); }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('info-ho-ten').textContent = data.ho_ten;
                        document.getElementById('barcode-display').textContent = `*${String(data.ma_co_dong).padStart(11, '0')}*`;
                        document.getElementById('info-cmnd').textContent = data.cmnd;
                        document.getElementById('info-ngay-cap').textContent = data.ngay_cap;
                        document.getElementById('info-so-luong-cp').textContent = data.so_luong_cp;

                        if (data.da_dang_ky) {
                            registerButton.style.display = 'none';
                            reprintButton.style.display = 'block';
                        } else {
                            registerButton.style.display = 'block';
                            reprintButton.style.display = 'none';
                        }
                        infoContainer.style.display = 'block';
                    })
                    .catch(error => {
                        infoContainer.style.display = 'none';
                    });
            }, 300);
        });

        function startSequentialPrint(maCD) {
            printSingleSlip(`/phieu-dang-ky/${maCD}`, () => {
                printSingleSlip(`/the-bieu-quyet/${maCD}`, () => {
                    printSingleSlip(`/phieu-bieu-quyet/${maCD}`, resetForm);
                });
            });
        }

        registerButton.addEventListener('click', function () {
            const maCD = inputField.value.trim();
            if (!maCD) { return; }

            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ma_co_dong: maCD }),
            })
                .then(response => response.json().then(data => ({ ok: response.ok, data: data })))
                .then(result => {
                    if (result.ok) {
                        startSequentialPrint(maCD);
                    } else {
                        throw new Error(result.data.message);
                    }
                })
                .catch(error => {
                    alert('Thất bại: ' + error.message);
                });
        });

        reprintButton.addEventListener('click', function () {
            const maCD = inputField.value.trim();
            if (maCD) {
                startSequentialPrint(maCD);
            }
        });
    </script>
</body>

</html>